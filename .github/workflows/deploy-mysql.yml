name: ğŸ—„ï¸ Deploy with MySQL Database

on:
  push:
    branches: [ gh-pages ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout do cÃ³digo
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    # 2. Setup Node.js
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    # 3. Instalar dependÃªncias
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    # 4. Configurar variÃ¡veis de ambiente
    - name: ğŸ”§ Setup Environment Variables
      env:
        BD_URL: ${{ secrets.BD_URL }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        RETOOL_API_KEY: ${{ secrets.RETOOL_API_KEY }}
        RETOOL_API_URL: ${{ secrets.RETOOL_API_URL }}
        RETOOL_APP_ID: ${{ secrets.RETOOL_APP_ID }}
      run: |
        echo "ğŸ”§ Configurando variÃ¡veis de ambiente..."
        
        # Verificar se a variÃ¡vel BD_URL existe
        if [ -z "$BD_URL" ]; then
          echo "âŒ ERRO: VariÃ¡vel secreta BD_URL nÃ£o encontrada!"
          echo "Configure a variÃ¡vel secreta no GitHub: Settings â†’ Secrets and variables â†’ Actions"
          exit 1
        fi
        
        # Criar arquivo .env para o build
        cat > .env << EOF
        BD_URL=$BD_URL
        JWT_SECRET=${JWT_SECRET:-fallback_jwt_secret_$(date +%s)}
        RETOOL_API_KEY=${RETOOL_API_KEY:-}
        RETOOL_API_URL=${RETOOL_API_URL:-}
        RETOOL_APP_ID=${RETOOL_APP_ID:-}
        NODE_ENV=production
        CORS_ORIGINS=https://${{ github.repository_owner }}.github.io
        EOF
        
        echo "âœ… VariÃ¡veis de ambiente configuradas"
        
    # 5. Gerar cliente Prisma
    - name: ğŸ› ï¸ Generate Prisma Client
      env:
        BD_URL: ${{ secrets.BD_URL }}
      run: |
        echo "ğŸ› ï¸ Gerando cliente Prisma..."
        npx prisma generate
        echo "âœ… Cliente Prisma gerado com sucesso"
        
    # 6. Executar migraÃ§Ãµes (opcional, apenas se necessÃ¡rio)
    - name: ğŸ—„ï¸ Run Database Migrations
      env:
        BD_URL: ${{ secrets.BD_URL }}
      run: |
        echo "ğŸ—„ï¸ Verificando necessidade de migraÃ§Ãµes..."
        
        # SÃ³ executar migraÃ§Ãµes se o banco estiver acessÃ­vel
        if npx prisma migrate status > /dev/null 2>&1; then
          echo "Executando migraÃ§Ãµes necessÃ¡rias..."
          npx prisma migrate deploy
        else
          echo "âš ï¸ Banco nÃ£o acessÃ­vel ou migraÃ§Ãµes nÃ£o necessÃ¡rias"
        fi
        
        echo "âœ… MigraÃ§Ãµes verificadas"
      continue-on-error: true
        
    # 7. Health Check do banco
    - name: ğŸ” Database Health Check
      env:
        BD_URL: ${{ secrets.BD_URL }}
      run: |
        echo "ğŸ” Verificando saÃºde do banco de dados..."
        
        # Tentar executar health check
        if npm run db:health > /dev/null 2>&1; then
          echo "âœ… Banco de dados acessÃ­vel e funcionando"
        else
          echo "âš ï¸ Banco de dados nÃ£o acessÃ­vel no momento do build"
          echo "Isso Ã© normal se o banco estÃ¡ em modo serverless"
        fi
      continue-on-error: true
        
    # 8. Build do projeto
    - name: ğŸ—ï¸ Build Project
      run: |
        echo "ğŸ—ï¸ Fazendo build do projeto..."
        
        # Se tiver script de build especÃ­fico
        if npm run --help | grep -q "build"; then
          echo "Executando npm run build..."
          npm run build
        else
          echo "Nenhum script de build especÃ­fico. Usando arquivos estÃ¡ticos."
        fi
        
        echo "âœ… Build concluÃ­do"
        
    # 9. Preparar arquivos para deploy
    - name: ğŸ“ Prepare Deploy Files
      run: |
        echo "ğŸ“ Preparando arquivos para deploy..."
        
        # Criar arquivo de configuraÃ§Ã£o para o cliente
        cat > database-config.js << 'EOF'
        // ConfiguraÃ§Ã£o do banco para o cliente
        window.DATABASE_CONFIG = {
          apiEndpoint: 'https://seu-backend-api.herokuapp.com/api',
          version: '${{ github.sha }}',
          deployTime: new Date().toISOString(),
          environment: 'production'
        };
        console.log('âœ… ConfiguraÃ§Ã£o do banco carregada para produÃ§Ã£o');
        EOF
        
        # Adicionar script aos HTMLs se necessÃ¡rio
        for file in *.html; do
          if [ -f "$file" ]; then
            # Adicionar script de configuraÃ§Ã£o se nÃ£o existir
            if ! grep -q "database-config.js" "$file"; then
              sed -i 's|</head>|    <script src="database-config.js"></script>\n</head>|g' "$file"
              echo "âœ… Script adicionado a $file"
            fi
          fi
        done
        
        echo "âœ… Arquivos preparados para deploy"
        
    # 10. Deploy para GitHub Pages
    - name: ğŸš€ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        force_orphan: true
        commit_message: 'ğŸ—„ï¸ Deploy with MySQL: ${{ github.event.head_commit.message }}'
        
    # 11. Notificar deploy completo
    - name: âœ… Deploy Complete
      run: |
        echo "âœ… Deploy concluÃ­do com sucesso!"
        echo "ğŸŒ Site disponÃ­vel em: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "ğŸ—„ï¸ MySQL configurado com variÃ¡vel secreta BD_URL"
        echo "ğŸ“Š Commit: ${{ github.sha }}"
        echo "ğŸ• Deploy realizado em: $(date)"
        
    # 12. Verificar saÃºde pÃ³s-deploy (opcional)
    - name: ğŸ” Post-Deploy Health Check
      run: |
        echo "ğŸ” Verificando site apÃ³s deploy..."
        
        # Aguardar um pouco para o deploy ser processado
        sleep 30
        
        # Verificar se o site estÃ¡ respondendo
        SITE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        
        if curl -s -I "$SITE_URL" | grep -q "200 OK"; then
          echo "âœ… Site estÃ¡ respondendo corretamente"
        else
          echo "âš ï¸ Site pode estar ainda sendo processado pelo GitHub Pages"
        fi
        
        echo "ğŸ‰ Processo de deploy finalizado!"
      continue-on-error: true