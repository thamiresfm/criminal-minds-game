name: 🔥 Deploy with Firebase Config

on:
  push:
    branches: [ gh-pages ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout do código
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    # 2. Setup Node.js
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    # 3. Instalar dependências
    - name: 📦 Install Dependencies
      run: npm ci
      
    # 4. Injetar configuração Firebase
    - name: 🔥 Inject Firebase Config
      env:
        DADOS_FIREBASE: ${{ secrets.DADOS_FIREBASE }}
      run: |
        echo "🔥 Injetando configuração Firebase..."
        
        # Verificar se a variável secreta existe
        if [ -z "$DADOS_FIREBASE" ]; then
          echo "❌ ERRO: Variável secreta DADOS_FIREBASE não encontrada!"
          echo "Configure a variável secreta no GitHub: Settings → Secrets and variables → Actions"
          exit 1
        fi
        
        # Criar script de configuração
        cat > firebase-config-injected.js << 'EOL'
        // Configuração Firebase injetada automaticamente
        window.FIREBASE_CONFIG = FIREBASE_CONFIG_PLACEHOLDER;
        console.log('✅ Firebase configurado via GitHub Actions');
        EOL
        
        # Substituir placeholder pela configuração real
        echo "Substituindo configuração..."
        sed -i "s|FIREBASE_CONFIG_PLACEHOLDER|$DADOS_FIREBASE|g" firebase-config-injected.js
        
        echo "✅ Configuração Firebase injetada com sucesso!"
        
    # 5. Adicionar script de configuração aos HTMLs
    - name: 📝 Update HTML Files
      run: |
        echo "📝 Atualizando arquivos HTML..."
        
        # Função para adicionar script aos HTMLs
        add_firebase_script() {
          local file=$1
          if [ -f "$file" ]; then
            # Verificar se já tem o script
            if ! grep -q "firebase-config-injected.js" "$file"; then
              # Adicionar antes do fechamento do </head>
              sed -i 's|</head>|    <script src="firebase-config-injected.js"></script>\n</head>|g' "$file"
              echo "✅ Script adicionado a $file"
            else
              echo "⚠️ Script já existe em $file"
            fi
          fi
        }
        
        # Adicionar a todos os arquivos HTML que precisam
        add_firebase_script "login.html"
        add_firebase_script "register.html"
        add_firebase_script "lobby.html"
        add_firebase_script "investigation.html"
        add_firebase_script "investigation-cards.html"
        
        echo "✅ Todos os arquivos HTML atualizados!"
        
    # 6. Build do projeto (se necessário)
    - name: 🏗️ Build Project
      run: |
        echo "🏗️ Verificando se precisa fazer build..."
        
        # Se tiver package.json com script de build
        if npm run --help | grep -q "build"; then
          echo "Executando npm run build..."
          npm run build
        else
          echo "Nenhum script de build encontrado. Usando arquivos estáticos."
        fi
        
    # 7. Deploy para GitHub Pages
    - name: 🚀 Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        force_orphan: true
        commit_message: '🔥 Deploy with Firebase Config: ${{ github.event.head_commit.message }}'
        
    # 8. Verificar deploy
    - name: ✅ Verify Deployment
      run: |
        echo "✅ Deploy concluído com sucesso!"
        echo "🌐 Site disponível em: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "🔥 Firebase configurado com variável secreta DADOS_FIREBASE"
        echo "📊 Commit: ${{ github.sha }}"