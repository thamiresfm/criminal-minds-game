name: ğŸ”¥ Deploy with Firebase Config

on:
  push:
    branches: [ gh-pages ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout do cÃ³digo
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    # 2. Setup Node.js
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    # 3. Instalar dependÃªncias
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    # 4. Injetar configuraÃ§Ã£o Firebase
    - name: ğŸ”¥ Inject Firebase Config
      env:
        DADOS_FIREBASE: ${{ secrets.DADOS_FIREBASE }}
      run: |
        echo "ğŸ”¥ Injetando configuraÃ§Ã£o Firebase..."
        
        # Verificar se a variÃ¡vel secreta existe
        if [ -z "$DADOS_FIREBASE" ]; then
          echo "âŒ ERRO: VariÃ¡vel secreta DADOS_FIREBASE nÃ£o encontrada!"
          echo "Configure a variÃ¡vel secreta no GitHub: Settings â†’ Secrets and variables â†’ Actions"
          exit 1
        fi
        
        # Criar script de configuraÃ§Ã£o
        cat > firebase-config-injected.js << 'EOL'
        // ConfiguraÃ§Ã£o Firebase injetada automaticamente
        window.FIREBASE_CONFIG = FIREBASE_CONFIG_PLACEHOLDER;
        console.log('âœ… Firebase configurado via GitHub Actions');
        EOL
        
        # Substituir placeholder pela configuraÃ§Ã£o real
        echo "Substituindo configuraÃ§Ã£o..."
        sed -i "s|FIREBASE_CONFIG_PLACEHOLDER|$DADOS_FIREBASE|g" firebase-config-injected.js
        
        echo "âœ… ConfiguraÃ§Ã£o Firebase injetada com sucesso!"
        
    # 5. Adicionar script de configuraÃ§Ã£o aos HTMLs
    - name: ğŸ“ Update HTML Files
      run: |
        echo "ğŸ“ Atualizando arquivos HTML..."
        
        # FunÃ§Ã£o para adicionar script aos HTMLs
        add_firebase_script() {
          local file=$1
          if [ -f "$file" ]; then
            # Verificar se jÃ¡ tem o script
            if ! grep -q "firebase-config-injected.js" "$file"; then
              # Adicionar antes do fechamento do </head>
              sed -i 's|</head>|    <script src="firebase-config-injected.js"></script>\n</head>|g' "$file"
              echo "âœ… Script adicionado a $file"
            else
              echo "âš ï¸ Script jÃ¡ existe em $file"
            fi
          fi
        }
        
        # Adicionar a todos os arquivos HTML que precisam
        add_firebase_script "login.html"
        add_firebase_script "register.html"
        add_firebase_script "lobby.html"
        add_firebase_script "investigation.html"
        add_firebase_script "investigation-cards.html"
        
        echo "âœ… Todos os arquivos HTML atualizados!"
        
    # 6. Build do projeto (se necessÃ¡rio)
    - name: ğŸ—ï¸ Build Project
      run: |
        echo "ğŸ—ï¸ Verificando se precisa fazer build..."
        
        # Se tiver package.json com script de build
        if npm run --help | grep -q "build"; then
          echo "Executando npm run build..."
          npm run build
        else
          echo "Nenhum script de build encontrado. Usando arquivos estÃ¡ticos."
        fi
        
    # 7. Deploy para GitHub Pages
    - name: ğŸš€ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        force_orphan: true
        commit_message: 'ğŸ”¥ Deploy with Firebase Config: ${{ github.event.head_commit.message }}'
        
    # 8. Verificar deploy
    - name: âœ… Verify Deployment
      run: |
        echo "âœ… Deploy concluÃ­do com sucesso!"
        echo "ğŸŒ Site disponÃ­vel em: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "ğŸ”¥ Firebase configurado com variÃ¡vel secreta DADOS_FIREBASE"
        echo "ğŸ“Š Commit: ${{ github.sha }}"