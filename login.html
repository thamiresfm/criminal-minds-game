<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Criminal Minds Game</title>
    <meta name="description" content="Fa√ßa login no Criminal Minds Game - Entre com email e senha">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f0f23);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            position: relative;
        }

        .background-effects {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(234, 179, 8, 0.1), transparent);
            pointer-events: none;
        }

        .glow-1 {
            position: absolute;
            top: 20%;
            left: 10%;
            width: 300px;
            height: 300px;
            background: rgba(234, 179, 8, 0.05);
            border-radius: 50%;
            filter: blur(3rem);
        }

        .glow-2 {
            position: absolute;
            bottom: 20%;
            right: 10%;
            width: 400px;
            height: 400px;
            background: rgba(239, 68, 68, 0.05);
            border-radius: 50%;
            filter: blur(3rem);
        }

        .login-card {
            background: rgba(31, 41, 55, 0.5);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(55, 65, 81, 0.5);
            border-radius: 2rem;
            padding: 3rem;
            width: 100%;
            max-width: 500px;
            position: relative;
            z-index: 10;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo h1 {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(to right, #fbbf24, #f59e0b, #f97316);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .logo p {
            color: #9ca3af;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #f3f4f6;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            background: rgba(17, 24, 39, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 0.75rem;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }

        .form-input::placeholder {
            color: #9ca3af;
        }

        .password-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
            z-index: 1;
        }

        .password-toggle:hover {
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        .password-toggle span {
            font-size: 1.1rem;
            display: block;
        }

        .password-container .form-input {
            padding-right: 3rem;
        }

        .login-button {
            width: 100%;
            background: linear-gradient(to right, #f59e0b, #f97316);
            color: black;
            border: none;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .login-button:hover {
            background: linear-gradient(to right, #fbbf24, #f59e0b);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -3px rgba(251, 191, 36, 0.25);
        }



        .back-link {
            text-align: center;
            margin-top: 1.5rem;
        }

        .back-link a {
            color: #9ca3af;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .back-link a:hover {
            color: #fbbf24;
        }

        .register-link {
            text-align: center;
            margin: 1.5rem 0;
            font-size: 0.9rem;
        }

        .register-link p {
            color: #9ca3af;
        }

        .register-link a {
            color: #fbbf24;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .register-link a:hover {
            color: #f59e0b;
            text-decoration: underline;
        }

        .features {
            text-align: center;
            margin-top: 2rem;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .features span {
            margin: 0 0.5rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-card {
            animation: fadeIn 0.6s ease-out;
        }
    </style>
    <script src="firebase-config-injected.js"></script>
    <script src="github-secrets-config.js"></script>
    <script src="js/api-client.js"></script>
    <script src="api-direct-postgres.js"></script>
</head>
<body>
    <div class="container">
        <div class="background-effects">
            <div class="glow-1"></div>
            <div class="glow-2"></div>
        </div>

        <div class="login-card">
            <div class="logo">
                <h1>üéØ Criminal Minds</h1>
                <p>Fa√ßa login para entrar na investiga√ß√£o</p>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" class="form-input" 
                           placeholder="Digite seu email" required>
                </div>

                <div class="form-group">
                    <label for="password">Senha</label>
                    <div class="password-container">
                        <input type="password" id="password" name="password" class="form-input" 
                               placeholder="Digite sua senha" required>
                        <button type="button" class="password-toggle" onclick="togglePassword()">
                            <span id="passwordIcon">üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>

                <button type="submit" class="login-button">
                    üïµÔ∏è Fazer Login
                </button>
            </form>

            <div class="register-link">
                <p>N√£o tem uma conta? <a href="register.html">Cadastre-se aqui</a></p>
            </div>

            <div class="features">
                <span>üéÆ Multiplayer</span>
                <span>‚Ä¢</span>
                <span>üïµÔ∏è Investiga√ß√£o</span>
                <span>‚Ä¢</span>
                <span>‚ö° Tempo Real</span>
            </div>

            <div class="back-link">
                <a href="index.html">‚Üê Voltar ao in√≠cio</a>
            </div>
        </div>
    </div>

    <script>
        // Fun√ß√£o para alternar visibilidade da senha
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const passwordIcon = document.getElementById('passwordIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                passwordIcon.textContent = 'üôà';
            } else {
                passwordInput.type = 'password';
                passwordIcon.textContent = 'üëÅÔ∏è';
            }
        }

        // Valida√ß√£o de email
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Fun√ß√£o para lidar com o login
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = document.querySelector('.login-button');
            const originalText = submitButton.innerHTML;
            
            try {
                // Desabilitar bot√£o durante processamento
                submitButton.disabled = true;
                submitButton.innerHTML = '‚è≥ Fazendo login...';
                submitButton.style.background = 'linear-gradient(to right, #6b7280, #4b5563)';
                
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                
                // Valida√ß√µes b√°sicas
                if (!email || !isValidEmail(email)) {
                    throw new Error('Por favor, digite um email v√°lido.');
                }
                
                if (!password) {
                    throw new Error('Por favor, digite sua senha.');
                }
                
                // Preparar dados para API
                const credentials = {
                    email: email,
                    password: password
                };
                
                // Fazer login via API MySQL
                const api = window.CriminalMindsAPI;
                let response;
                
                try {
                    response = await api.login(credentials);
                } catch (apiError) {
                    console.warn('‚ö†Ô∏è API principal offline, tentando API direta PostgreSQL:', apiError.message);
                    
                    // Tentar API direta PostgreSQL
                    try {
                        response = await window.DirectPostgreSQL.login(credentials);
                        
                        if (response.success) {
                            console.log('‚úÖ Login realizado via API direta PostgreSQL');
                        }
                    } catch (directError) {
                        console.warn('‚ö†Ô∏è API direta tamb√©m falhou, tentando modo offline:', directError.message);
                        throw apiError; // Manter erro original da API principal
                    }
                }
                
                if (response.success) {
                    // Feedback visual de sucesso
                    submitButton.innerHTML = '‚úÖ Login realizado com sucesso!';
                    submitButton.style.background = 'linear-gradient(to right, #10b981, #059669)';
                    
                    console.log('üéâ Login bem-sucedido:', response.user.email);
                    
                    // Redirecionar para o lobby ap√≥s 1.5 segundos
                    setTimeout(() => {
                        window.location.href = 'lobby.html';
                    }, 1500);
                } else {
                    throw new Error(response.error || 'Erro desconhecido no login');
                }
                
            } catch (error) {
                console.error('‚ùå Erro no login:', error);
                
                // Verificar se √© erro de rede (API offline)
                const isNetworkError = error.message.includes('fetch') || 
                                     error.message.includes('Failed to fetch') ||
                                     error.message.includes('NetworkError') ||
                                     error.message.includes('net::');
                
                if (isNetworkError) {
                    console.warn('‚ö†Ô∏è API offline, tentando login local');
                    
                    try {
                        // Fallback para localStorage (modo offline)
                        const existingUserData = localStorage.getItem('criminalMinds_userData');
                        
                        if (existingUserData) {
                            const userData = JSON.parse(existingUserData);
                            
                            // Verificar credenciais locais
                            if (userData.email === document.getElementById('email').value.trim() && 
                                userData.password === document.getElementById('password').value) {
                                
                                // Login local bem-sucedido
                                localStorage.setItem('criminalMinds_username', userData.detectiveName);
                                localStorage.setItem('criminalMinds_userEmail', userData.email);
                                localStorage.setItem('criminalMinds_isLoggedIn', 'true');
                                
                                if (userData.gameCode) {
                                    localStorage.setItem('criminalMinds_gameCode', userData.gameCode);
                                }
                                
                                // Feedback de modo offline
                                submitButton.innerHTML = '‚ö†Ô∏è Login offline realizado';
                                submitButton.style.background = 'linear-gradient(to right, #f59e0b, #f97316)';
                                
                                console.log('üì¥ Login local bem-sucedido, ser√° sincronizado quando API estiver dispon√≠vel');
                                
                                // Redirecionar
                                setTimeout(() => {
                                    window.location.href = 'lobby.html';
                                }, 1800);
                                
                                return; // Sair da fun√ß√£o sem mostrar erro
                                
                            } else {
                                throw new Error('Email ou senha incorretos.');
                            }
                        } else {
                            throw new Error('Usu√°rio n√£o encontrado. Fa√ßa seu cadastro primeiro.');
                        }
                        
                    } catch (fallbackError) {
                        console.error('‚ùå Erro no login local:', fallbackError);
                        error.message = fallbackError.message;
                    }
                }
                
                // Mostrar erro para o usu√°rio
                let errorMessage = error.message;
                
                // Customizar mensagens de erro comuns
                if (errorMessage.includes('Email ou senha incorretos')) {
                    errorMessage = 'Email ou senha incorretos. Verifique seus dados.';
                } else if (errorMessage.includes('Usu√°rio n√£o encontrado')) {
                    errorMessage = 'Usu√°rio n√£o encontrado. Fa√ßa seu cadastro primeiro.';
                } else if (errorMessage.includes('Conta desativada')) {
                    errorMessage = 'Sua conta foi desativada. Entre em contato com o suporte.';
                } else if (errorMessage.includes('fetch')) {
                    errorMessage = 'Erro de conex√£o. Verifique sua internet.';
                }
                
                // Feedback visual de erro
                submitButton.innerHTML = '‚ùå ' + errorMessage;
                submitButton.style.background = 'linear-gradient(to right, #ef4444, #dc2626)';
                
                // Restaurar bot√£o ap√≥s 3 segundos
                setTimeout(() => {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                    submitButton.style.background = 'linear-gradient(to right, #f59e0b, #f97316)';
                }, 3500);
            }
        });



        // Efeito de foco nos inputs com ajuste para password container
        document.querySelectorAll('.form-input').forEach(input => {
            input.addEventListener('focus', function() {
                const container = this.closest('.password-container') || this.parentElement;
                container.style.transform = 'scale(1.02)';
                container.style.transition = 'transform 0.3s ease';
            });
            
            input.addEventListener('blur', function() {
                const container = this.closest('.password-container') || this.parentElement;
                container.style.transform = 'scale(1)';
            });
        });

        // Feedback visual para email v√°lido
        document.getElementById('email').addEventListener('input', function() {
            const email = this.value.trim();
            if (email && isValidEmail(email)) {
                this.style.borderColor = '#10b981';
                this.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
            } else if (email) {
                this.style.borderColor = '#ef4444';
                this.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
            } else {
                this.style.borderColor = 'rgba(75, 85, 99, 0.5)';
                this.style.boxShadow = 'none';
            }
        });
    </script>
</body>
</html>